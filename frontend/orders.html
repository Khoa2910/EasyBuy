<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n h√†ng c·ªßa t√¥i - EasyBuy</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom Theme -->
    <link href="assets/css/customer-theme.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-shopping-bag"></i>EasyBuy
            </a>
            
            <div class="navbar-nav ms-auto">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home me-1"></i>Trang ch·ªß
                </a>
                <a href="products.html" class="nav-link">
                    <i class="fas fa-box me-1"></i>S·∫£n ph·∫©m
                </a>
                <a href="cart.html" class="nav-link">
                    <i class="fas fa-shopping-cart me-1"></i>Gi·ªè h√†ng
                </a>
                <a href="orders.html" class="nav-link active">
                    <i class="fas fa-shopping-bag me-1"></i>ƒê∆°n h√†ng
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4">
                    <i class="fas fa-shopping-bag me-2"></i>ƒê∆°n h√†ng c·ªßa t√¥i
                </h2>
                
                <!-- Filter Tabs -->
                <ul class="nav nav-tabs mb-4" id="orderTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                            T·∫•t c·∫£
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                            Ch·ªù x√°c nh·∫≠n
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed" type="button" role="tab">
                            ƒê√£ x√°c nh·∫≠n
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="delivering-tab" data-bs-toggle="tab" data-bs-target="#delivering" type="button" role="tab">
                            ƒêang giao
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="delivered-tab" data-bs-toggle="tab" data-bs-target="#delivered" type="button" role="tab">
                            ƒê√£ giao
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab">
                            Ho√†n t·∫•t
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="orderTabContent">
                    <!-- All Orders -->
                    <div class="tab-pane fade show active" id="all" role="tabpanel">
                        <div id="allOrders">
                            <!-- Orders will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Pending Orders -->
                    <div class="tab-pane fade" id="pending" role="tabpanel">
                        <div id="pendingOrders">
                            <!-- Pending orders will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Confirmed Orders -->
                    <div class="tab-pane fade" id="confirmed" role="tabpanel">
                        <div id="confirmedOrders">
                            <!-- Confirmed orders will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Delivering Orders -->
                    <div class="tab-pane fade" id="delivering" role="tabpanel">
                        <div id="deliveringOrders">
                            <!-- Delivering orders will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Delivered Orders -->
                    <div class="tab-pane fade" id="delivered" role="tabpanel">
                        <div id="deliveredOrders">
                            <!-- Delivered orders will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Completed Orders -->
                    <div class="tab-pane fade" id="completed" role="tabpanel">
                        <div id="completedOrders">
                            <!-- Completed orders will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-receipt me-2"></i>Chi ti·∫øt ƒë∆°n h√†ng
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailBody">
                    <!-- dynamic content -->
                </div>
                <div class="modal-footer" id="orderDetailFooter">
                    <!-- dynamic actions -->
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Order Modal -->
    <div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-times-circle me-2 text-danger"></i>H·ªßy ƒë∆°n h√†ng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Vui l√≤ng ch·ªçn l√Ω do h·ªßy ƒë∆°n:</p>
                    <div class="list-group" id="cancelReasonList">
                        <label class="list-group-item">
                            <input class="form-check-input me-2" type="radio" name="cancelReason" value="ƒê·∫∑t nh·∫ßm s·∫£n ph·∫©m"> ƒê·∫∑t nh·∫ßm s·∫£n ph·∫©m
                        </label>
                        <label class="list-group-item">
                            <input class="form-check-input me-2" type="radio" name="cancelReason" value="T√¨m ƒë∆∞·ª£c gi√° t·ªët h∆°n"> T√¨m ƒë∆∞·ª£c gi√° t·ªët h∆°n
                        </label>
                        <label class="list-group-item">
                            <input class="form-check-input me-2" type="radio" name="cancelReason" value="Thay ƒë·ªïi ƒë·ªãa ch·ªâ/th·ªùi gian nh·∫≠n h√†ng"> Thay ƒë·ªïi ƒë·ªãa ch·ªâ/th·ªùi gian nh·∫≠n h√†ng
                        </label>
                        <label class="list-group-item">
                            <input class="form-check-input me-2" type="radio" name="cancelReason" value="Th·ªùi gian giao h√†ng qu√° l√¢u"> Th·ªùi gian giao h√†ng qu√° l√¢u
                        </label>
                        <label class="list-group-item">
                            <input class="form-check-input me-2" type="radio" name="cancelReason" value="Mu·ªën ch·ªânh s·ª≠a ƒë∆°n h√†ng"> Mu·ªën ch·ªânh s·ª≠a ƒë∆°n h√†ng
                        </label>
                        <label class="list-group-item">
                            <input class="form-check-input me-2" type="radio" name="cancelReason" value="L√Ω do kh√°c"> L√Ω do kh√°c
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-danger" id="confirmCancelBtn">
                        <i class="fas fa-check me-1"></i>X√°c nh·∫≠n h·ªßy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        class OrdersPage {
            constructor() {
                this.orders = [];
                this.init();
            }
            
            init() {
                this.loadOrders();
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // Tab change events
                document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                    tab.addEventListener('shown.bs.tab', (e) => {
                        const target = e.target.getAttribute('data-bs-target');
                        this.filterOrders(target);
                    });
                });
            }
            
            async loadOrders() {
                try {
                    const token = localStorage.getItem('accessToken');
                    const res = await fetch('/api/orders', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    if (!res.ok) throw new Error('Failed to fetch');
                    const data = await res.json();
                    const orders = data.success ? data.orders : data;

                    // For each order, fetch items to display thumbnails
                    const detailed = await Promise.all((orders || []).map(async (o) => {
                        try {
                            const r = await fetch(`/api/orders/${o.id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                            if (!r.ok) return o;
                            const d = await r.json();
                            return { ...o, items: d.order.items || [] };
                        } catch (_) {
                            return o;
                        }
                    }));

                    this.orders = detailed.map(o => ({
                        id: o.id,
                        date: o.created_at || new Date().toISOString(),
                        status: o.status || 'pending',
                        total: o.total_amount || 0,
                        items: (o.items || []).map(it => ({
                            name: it.product_name,
                            quantity: it.quantity,
                            price: it.total_price,
                            image_url: it.image_url
                        }))
                    }));

                    this.renderOrders();
                } catch (error) {
                    console.error('Error loading orders:', error);
                    this.showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë∆°n h√†ng');
                }
            }
            
            renderOrders() {
                this.renderOrderList('allOrders', this.orders);
                this.renderOrderList('pendingOrders', this.orders.filter(o => o.status === 'pending'));
                this.renderOrderList('confirmedOrders', this.orders.filter(o => o.status === 'confirmed'));
                this.renderOrderList('deliveringOrders', this.orders.filter(o => o.status === 'delivering'));
                this.renderOrderList('deliveredOrders', this.orders.filter(o => o.status === 'delivered'));
                this.renderOrderList('completedOrders', this.orders.filter(o => o.status === 'completed'));
            }
            
            renderOrderList(containerId, orders) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h5>
                            <a href="products.html" class="btn btn-primary">Mua s·∫Øm ngay</a>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = orders.map(order => this.renderOrderCard(order)).join('');
            }
            
            renderOrderCard(order) {
                const statusInfo = this.getStatusInfo(order.status);
                const formattedDate = new Date(order.date).toLocaleDateString('vi-VN');
                const formattedTotal = order.total.toLocaleString('vi-VN') + ' VNƒê';
                
                return `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">ƒê∆°n h√†ng #${order.id}</h6>
                                <small class="text-muted">${formattedDate}</small>
                            </div>
                            <span class="badge ${statusInfo.class}">${statusInfo.text}</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>S·∫£n ph·∫©m:</h6>
                                    <ul class="list-unstyled">
                                        ${order.items.map(item => `
                                            <li class="d-flex justify-content-between align-items-center">
                                                <div class="d-flex align-items-center">
                                                    <img src="${item.image_url || 'assets/images/placeholder.jpg'}" class="rounded me-2" style="width:40px;height:40px;object-fit:cover;" onerror="this.src='assets/images/placeholder.jpg'">
                                                    <span>${item.name} x${item.quantity}</span>
                                                </div>
                                                <span>${Number(item.price).toLocaleString('vi-VN')} VNƒê</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                <div class="col-md-4 text-end">
                                    <h6>T·ªïng c·ªông: ${formattedTotal}</h6>
                                    <div class="mt-2">
                                        <button class="btn btn-outline-primary btn-sm me-2" onclick="ordersPage.viewOrder('${order.id}')">
                                            <i class="fas fa-eye me-1"></i>Xem chi ti·∫øt
                                        </button>
                                        ${order.status === 'pending' ? `
                                            <button class="btn btn-outline-danger btn-sm" onclick="ordersPage.cancelOrder('${order.id}')">
                                                <i class="fas fa-times me-1"></i>H·ªßy ƒë∆°n
                                            </button>
                                        ` : ''}
                                        ${order.status === 'completed' ? `
                                            <button class="btn btn-outline-warning btn-sm me-2" onclick="ordersPage.reviewOrder('${order.id}')">
                                                <i class="fas fa-star me-1"></i>ƒê√°nh gi√°
                                            </button>
                                            <button class="btn btn-outline-success btn-sm" onclick="ordersPage.reorder('${order.id}')">
                                                <i class="fas fa-redo me-1"></i>Mua l·∫°i
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            getStatusInfo(status) {
                const statusMap = {
                    'pending': { text: 'Ch·ªù x√°c nh·∫≠n', class: 'bg-warning', icon: 'fa-clock' },
                    'confirmed': { text: 'ƒê√£ x√°c nh·∫≠n', class: 'bg-info', icon: 'fa-check-circle' },
                    'delivering': { text: 'ƒêang giao h√†ng', class: 'bg-primary', icon: 'fa-shipping-fast' },
                    'delivered': { text: 'ƒê√£ giao h√†ng', class: 'bg-success', icon: 'fa-box-check' },
                    'completed': { text: 'Ho√†n t·∫•t', class: 'bg-success', icon: 'fa-check-double' },
                    'cancelled': { text: 'ƒê√£ h·ªßy', class: 'bg-danger', icon: 'fa-times-circle' }
                };
                return statusMap[status] || { text: 'Kh√¥ng x√°c ƒë·ªãnh', class: 'bg-secondary', icon: 'fa-question' };
            }
            
            filterOrders(target) {
                // This method is called when tabs change
                // The rendering is already handled in renderOrders()
            }
            
            async viewOrder(orderId) {
                try {
                    const token = localStorage.getItem('accessToken');
                    const res = await fetch(`/api/orders/${orderId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error('Failed to load order');
                    const data = await res.json();
                    const order = data.order || data;

                    const info = this.getStatusInfo(order.status);

                    // Body
                    const bodyEl = document.getElementById('orderDetailBody');
                    
                    // Order tracking timeline
                    const statuses = ['pending', 'confirmed', 'delivering', 'delivered', 'completed'];
                    const currentIndex = statuses.indexOf(order.status);
                    const isCancelled = order.status === 'cancelled';
                    
                    const timeline = !isCancelled ? `
                        <div class="mb-4">
                            <h6 class="mb-3">Tr·∫°ng th√°i ƒë∆°n h√†ng</h6>
                            <div class="d-flex justify-content-between position-relative" style="padding: 0 20px;">
                                <div class="position-absolute" style="top: 15px; left: 20px; right: 20px; height: 2px; background: linear-gradient(to right, ${statuses.map((s, i) => i <= currentIndex ? '#28a745' : '#dee2e6').join(', ')});"></div>
                                ${statuses.map((s, i) => {
                                    const sInfo = this.getStatusInfo(s);
                                    const isActive = i <= currentIndex;
                                    return `
                                        <div class="text-center position-relative" style="z-index: 1;">
                                            <div class="mb-2">
                                                <div class="rounded-circle d-flex align-items-center justify-content-center mx-auto" 
                                                     style="width: 30px; height: 30px; background: ${isActive ? '#28a745' : '#dee2e6'}; color: white;">
                                                    <i class="fas ${sInfo.icon} ${isActive ? '' : 'text-muted'}"></i>
                                                </div>
                                            </div>
                                            <small class="${isActive ? 'text-success fw-bold' : 'text-muted'}">${sInfo.text}</small>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="alert alert-danger mb-3">
                            <i class="fas fa-times-circle me-2"></i>ƒê∆°n h√†ng ƒë√£ b·ªã h·ªßy
                        </div>
                    `;
                    
                    bodyEl.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="mb-1">ƒê∆°n h√†ng #${order.id}</h6>
                                <small class="text-muted">${new Date(order.created_at).toLocaleString('vi-VN')}</small>
                            </div>
                            <span class="badge ${info.class}"><i class="fas ${info.icon} me-1"></i>${info.text}</span>
                        </div>
                        ${timeline}
                        <div class="mb-3">
                            <h6 class="mb-2">S·∫£n ph·∫©m</h6>
                            <ul class="list-group">
                                ${(order.items || []).map(it => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <img src="${it.image_url || 'assets/images/placeholder.jpg'}" class="rounded me-2" style="width:48px;height:48px;object-fit:cover;" onerror="this.src='assets/images/placeholder.jpg'">
                                            <div>
                                                <div>${it.product_name}</div>
                                                <small class="text-muted">SL: ${it.quantity}</small>
                                            </div>
                                        </div>
                                        <span>${Number(it.total_price).toLocaleString('vi-VN')} VNƒê</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        <div class="d-flex justify-content-end gap-4">
                            <div>Ph√≠ v·∫≠n chuy·ªÉn: <strong>${Number(order.shipping_cost || 0).toLocaleString('vi-VN')} VNƒê</strong></div>
                            <div>Thu·∫ø: <strong>${Number(order.tax_amount || 0).toLocaleString('vi-VN')} VNƒê</strong></div>
                            <div>T·ªïng c·ªông: <strong class="text-primary">${Number(order.total_amount || 0).toLocaleString('vi-VN')} VNƒê</strong></div>
                        </div>
                    `;

                    // Footer actions
                    const footerEl = document.getElementById('orderDetailFooter');
                    footerEl.innerHTML = `
                        ${order.status === 'pending' ? `<button class="btn btn-outline-danger" id="cancelOrderBtn"><i class="fas fa-times me-1"></i>H·ªßy ƒë∆°n h√†ng</button>` : ''}
                        ${order.status === 'completed' ? `
                            <button class="btn btn-outline-warning" id="reviewOrderBtn"><i class="fas fa-star me-1"></i>ƒê√°nh gi√° s·∫£n ph·∫©m</button>
                            <button class="btn btn-outline-success" id="reorderBtn"><i class="fas fa-redo me-1"></i>Mua l·∫°i</button>
                        ` : ''}
                        <button class="btn btn-primary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    `;

                    if (order.status === 'pending') {
                        document.getElementById('cancelOrderBtn').onclick = () => this.openCancelModal(order.id);
                    }
                    
                    if (order.status === 'completed') {
                        document.getElementById('reviewOrderBtn').onclick = () => this.reviewOrder(order.id);
                        document.getElementById('reorderBtn').onclick = () => this.reorder(order.id);
                    }

                    const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
                    modal.show();
                } catch (e) {
                    console.error(e);
                    this.showError('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
                }
            }

            cancelOrder(orderId) {
                this.openCancelModal(orderId);
            }

            openCancelModal(orderId) {
                this._cancelOrderId = orderId;
                // pre-select first reason
                const first = document.querySelector('#cancelReasonList input[name="cancelReason"]');
                if (first) first.checked = true;
                new bootstrap.Modal(document.getElementById('cancelOrderModal')).show();
                document.getElementById('confirmCancelBtn').onclick = () => this.cancelOrderConfirmed();
            }

            async cancelOrderConfirmed() {
                const orderId = this._cancelOrderId;
                const selected = document.querySelector('input[name="cancelReason"]:checked');
                const reason = selected ? selected.value : '';
                
                console.log('üîÑ Cancelling order:', orderId, 'Reason:', reason);
                
                try {
                    const token = localStorage.getItem('accessToken');
                    console.log('üîë Using token:', token ? 'Present' : 'Missing');
                    
                    const res = await fetch(`/api/orders/${orderId}/cancel`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ reason })
                    });
                    
                    console.log('üìä Cancel response status:', res.status);
                    const data = await res.json();
                    console.log('üì¶ Cancel response data:', data);
                    
                    if (!res.ok || !data.success) {
                        const msg = data && (data.message || data.error || 'Cancel failed');
                        const details = data && data.details ? `\nChi ti·∫øt: ${data.details}` : '';
                        alert(`‚ùå H·ªßy ƒë∆°n h√†ng th·∫•t b·∫°i: ${msg}${details}`);
                        throw new Error(msg);
                    }

                    alert('‚úÖ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c h·ªßy th√†nh c√¥ng!');

                    // Refresh list and close modal
                    await this.loadOrders();
                    bootstrap.Modal.getInstance(document.getElementById('orderDetailModal'))?.hide();
                    bootstrap.Modal.getInstance(document.getElementById('cancelOrderModal'))?.hide();
                } catch (e) {
                    console.error('‚ùå Cancel failed:', e);
                    alert('‚ùå Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng: ' + e.message);
                }
            }
            
            reviewOrder(orderId) {
                // Redirect to review page or open review modal
                alert(`Ch·ª©c nƒÉng ƒë√°nh gi√° ƒë∆°n h√†ng #${orderId} ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn.`);
                // TODO: Implement review functionality
                // window.location.href = `review.html?order=${orderId}`;
            }
            
            reorder(orderId) {
                alert(`Mua l·∫°i ƒë∆°n h√†ng #${orderId}`);
                // Here you would add items to cart
            }
            
            showError(message) {
                const container = document.getElementById('allOrders');
                if (container) {
                    container.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>${message}
                        </div>
                    `;
                }
            }
        }
        
        // Initialize when page loads
        let ordersPage;
        document.addEventListener('DOMContentLoaded', () => {
            ordersPage = new OrdersPage();
        });
    </script>
</body>
</html>

