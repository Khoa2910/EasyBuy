<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết sản phẩm - EasyBuy</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom Theme -->
    <link href="assets/css/customer-theme.css" rel="stylesheet">
    
    <style>
        .product-image {
            max-height: 500px;
            object-fit: cover;
        }
        .product-gallery img {
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .product-gallery img:hover {
            opacity: 0.7;
        }
        .price-tag {
            font-size: 2rem;
            font-weight: bold;
            color: #e74c3c;
        }
        .original-price {
            text-decoration: line-through;
            color: #7f8c8d;
        }
        .rating {
            color: #f39c12;
        }
        .quantity-input {
            width: 80px;
        }
        .product-tabs {
            margin-top: 3rem;
        }
        .tab-content {
            padding: 2rem 0;
        }
        .specification-table {
            background: #f8f9fa;
        }
        .related-products .card {
            transition: transform 0.3s;
        }
        .related-products .card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body>
    <!-- Navigation (unified) -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-shopping-bag"></i>EasyBuy
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Trang chủ</a></li>
                    <li class="nav-item"><a class="nav-link" href="products.html">Sản phẩm</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">Giới thiệu</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Liên hệ</a></li>
                </ul>
                <form class="d-flex me-3" id="searchFormTop">
                    <div class="input-group">
                        <input class="form-control" type="search" placeholder="Tìm kiếm sản phẩm..." id="searchInputTop">
                        <button class="btn btn-outline-light" type="submit"><i class="fas fa-search"></i></button>
                    </div>
                </form>
                <div class="d-flex align-items-center">
                    <a href="wishlist.html" class="btn btn-outline-light me-2" title="Yêu thích">
                        <i class="fas fa-heart"></i>
                        <span class="badge bg-danger" id="wishlistCount">0</span>
                    </a>
                    <a href="cart.html" class="btn btn-outline-light me-2" title="Giỏ hàng">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="badge bg-danger" id="cartCount">0</span>
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" id="userDropdown">
                            <i class="fas fa-user"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" id="userMenu"></ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container mt-3" style="margin-top: 76px !important;">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="products.html">Sản phẩm</a></li>
                <li class="breadcrumb-item active" id="productCategory">Danh mục</li>
                <li class="breadcrumb-item active" id="productName">Tên sản phẩm</li>
            </ol>
        </nav>
    </div>

    <!-- Product Detail -->
    <div class="container my-5">
        <div class="row">
            <!-- Product Images -->
            <div class="col-md-6">
                <div class="product-gallery">
                    <img id="mainImage" src="https://via.placeholder.com/500x500?text=No+Image" 
                         class="img-fluid rounded product-image w-100 mb-3" alt="Sản phẩm">
                    
                    <div class="row" id="thumbnailGallery">
                        <!-- Thumbnails will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Product Info -->
            <div class="col-md-6">
                <h1 id="productTitle" class="mb-3">Tên sản phẩm</h1>
                
                <div class="rating mb-3" id="productRating">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="far fa-star"></i>
                    <span class="ms-2">(0 đánh giá)</span>
                </div>
                
                <div class="price-tag mb-3">
                    <span id="currentPrice">0 ₫</span>
                    <span id="originalPrice" class="original-price ms-2" style="display: none;">0 ₫</span>
                </div>
                
                <div class="mb-3">
                    <span class="badge bg-success" id="productStatus">Còn hàng</span>
                    <span class="badge bg-info ms-2" id="productStock">Còn 0 sản phẩm</span>
                </div>
                
                <div class="mb-4">
                    <h6>Mô tả ngắn:</h6>
                    <p id="productShortDesc" class="text-muted">Mô tả sản phẩm sẽ được hiển thị ở đây...</p>
                </div>
                
                <!-- Quantity and Add to Cart -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="quantity" class="form-label">Số lượng:</label>
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity()">-</button>
                            <input type="number" class="form-control text-center quantity-input" id="quantity" value="1" min="1">
                            <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity()">+</button>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-block mb-4">
                    <button class="btn btn-primary btn-lg" onclick="addToCart()">
                        <i class="fas fa-cart-plus me-2"></i>Thêm vào giỏ hàng
                    </button>
                    <button class="btn btn-success btn-lg" onclick="buyNow()">
                        <i class="fas fa-bolt me-2"></i>Mua ngay
                    </button>
                </div>
                
                <div class="d-grid gap-2 d-md-block">
                    <button class="btn btn-outline-danger" onclick="toggleWishlist()" id="wishlistBtn">
                        <i class="far fa-heart me-2"></i>Thêm vào yêu thích
                    </button>
                    <button class="btn btn-outline-info" onclick="shareProduct()">
                        <i class="fas fa-share me-2"></i>Chia sẻ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Product Tabs -->
        <div class="product-tabs">
            <ul class="nav nav-tabs" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" 
                            data-bs-target="#description" type="button" role="tab">
                        Mô tả chi tiết
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="specifications-tab" data-bs-toggle="tab" 
                            data-bs-target="#specifications" type="button" role="tab">
                        Thông số kỹ thuật
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" 
                            data-bs-target="#reviews" type="button" role="tab">
                        Đánh giá (0)
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="productTabContent">
                <div class="tab-pane fade show active" id="description" role="tabpanel">
                    <div id="productDescription">
                        <p>Mô tả chi tiết sản phẩm sẽ được hiển thị ở đây...</p>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="specifications" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-bordered specification-table" id="specificationsTable">
                            <tbody>
                                <tr>
                                    <td><strong>Thương hiệu</strong></td>
                                    <td id="productBrand">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Danh mục</strong></td>
                                    <td id="productCategoryDetail">-</td>
                                </tr>
                                <tr>
                                    <td><strong>SKU</strong></td>
                                    <td id="productSKU">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Trọng lượng</strong></td>
                                    <td id="productWeight">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="reviews" role="tabpanel">
                    <div id="reviewsContent">
                        <p class="text-muted">Chưa có đánh giá nào cho sản phẩm này.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Related Products -->
        <div class="mt-5">
            <h3 class="mb-4">Sản phẩm liên quan</h3>
            <div class="row" id="relatedProducts">
                <!-- Related products will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-5 mt-5">
        <div class="container-fluid px-4">
            <div class="row">
                <div class="col-md-4">
                    <h5>EasyBuy</h5>
                    <p>Nền tảng thương mại điện tử hàng đầu Việt Nam</p>
                </div>
                <div class="col-md-4">
                    <h5>Liên kết</h5>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-light">Về chúng tôi</a></li>
                        <li><a href="#" class="text-light">Liên hệ</a></li>
                        <li><a href="#" class="text-light">Hỗ trợ</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Theo dõi chúng tôi</h5>
                    <div class="d-flex gap-3">
                        <a href="#" class="text-light"><i class="fab fa-facebook fa-2x"></i></a>
                        <a href="#" class="text-light"><i class="fab fa-twitter fa-2x"></i></a>
                        <a href="#" class="text-light"><i class="fab fa-instagram fa-2x"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="assets/js/app.js"></script>
    
    <script>
        // Initialize TMDT App
        let app;
        let currentProduct = null;
        let currentQuantity = 1;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing TMDT App for product detail...');
            app = new TMDTApp();
            loadProduct();
            updateUserMenu();
            if (window.app && typeof app.loadCart === 'function') {
                app.loadCart();
            } else {
                loadCartCount();
            }
        });

        // Load product details
        async function loadProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (!productId) {
                alert('Không tìm thấy sản phẩm!');
                window.location.href = 'products.html';
                return;
            }

            try {
                const response = await fetch(`/api/products/${productId}`);
                const data = await response.json();
                
                if (response.ok) {
                    currentProduct = data;
                    displayProduct(data);
                    loadRelatedProducts(data.category_id || data.categoryId, data.brand_id || data.brandId);
                } else {
                    throw new Error(data.message || 'Không thể tải sản phẩm');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Không thể tải thông tin sản phẩm!');
                window.location.href = 'products.html';
            }
        }

        // Display product information
        function displayProduct(product) {
            // Basic info
            document.getElementById('productTitle').textContent = product.name;
            document.getElementById('productName').textContent = product.name;
            document.getElementById('productShortDesc').textContent = product.description || 'Không có mô tả';
            document.getElementById('productDescription').innerHTML = product.description || '<p>Không có mô tả chi tiết</p>';
            
            // Price (ưu tiên sale_price nếu có)
            const activePrice = (product.is_on_sale && product.sale_price) ? product.sale_price : product.price;
            const currentPrice = activePrice ? Number(activePrice).toLocaleString('vi-VN') : '0';
            document.getElementById('currentPrice').textContent = currentPrice + ' ₫';
            const original = product.compare_price || (product.is_on_sale ? product.price : null);
            const originalEl = document.getElementById('originalPrice');
            if (original) {
                originalEl.style.display = '';
                originalEl.textContent = Number(original).toLocaleString('vi-VN') + ' ₫';
            } else {
                originalEl.style.display = 'none';
            }
            
            // Stock and status
            const stock = product.stock_quantity || product.stock || 0;
            document.getElementById('productStock').textContent = `Còn ${stock} sản phẩm`;
            
            if (stock > 0) {
                document.getElementById('productStatus').textContent = 'Còn hàng';
                document.getElementById('productStatus').className = 'badge bg-success';
            } else {
                document.getElementById('productStatus').textContent = 'Hết hàng';
                document.getElementById('productStatus').className = 'badge bg-danger';
            }
            
            // Images
            if (product.images && product.images.length > 0) {
                const urls = product.images.map(img => img.image_url || img);
                document.getElementById('mainImage').src = urls[0] || 'https://via.placeholder.com/500x500?text=No+Image';
                displayThumbnails(urls);
            }
            
            // Specifications
            document.getElementById('productBrand').textContent = product.brand_name || '-';
            document.getElementById('productCategoryDetail').textContent = product.category_name || '-';
            document.getElementById('productCategory').textContent = product.category_name || 'Danh mục';
            document.getElementById('productSKU').textContent = product.sku || '-';
            document.getElementById('productWeight').textContent = product.weight ? product.weight + 'g' : '-';
            
            // Rating
            updateRating(product.rating || 0, product.review_count || 0);
            
            // Update page title
            document.title = product.name + ' - EasyBuy';
        }

        // Display product thumbnails
        function displayThumbnails(images) {
            const gallery = document.getElementById('thumbnailGallery');
            gallery.innerHTML = '';
            
            images.forEach((image, index) => {
                const col = document.createElement('div');
                col.className = 'col-3 mb-2';
                col.innerHTML = `
                    <img src="${image}" class="img-fluid rounded" 
                         onclick="changeMainImage('${image}')" 
                         style="height: 80px; object-fit: cover; width: 100%;">
                `;
                gallery.appendChild(col);
            });
        }

        // Change main image
        function changeMainImage(imageSrc) {
            document.getElementById('mainImage').src = imageSrc;
        }

        // Update rating display
        function updateRating(rating, reviewCount) {
            const ratingElement = document.getElementById('productRating');
            const stars = ratingElement.querySelectorAll('i');
            
            stars.forEach((star, index) => {
                if (index < Math.floor(rating)) {
                    star.className = 'fas fa-star';
                } else if (index < rating) {
                    star.className = 'fas fa-star-half-alt';
                } else {
                    star.className = 'far fa-star';
                }
            });
            
            const reviewText = ratingElement.querySelector('span');
            reviewText.textContent = `(${reviewCount} đánh giá)`;
        }

        // Quantity controls
        function increaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            const maxStock = currentProduct ? (currentProduct.stock_quantity || currentProduct.stock || 0) : 0;
            const currentValue = parseInt(quantityInput.value);
            
            if (currentValue < maxStock) {
                quantityInput.value = currentValue + 1;
                currentQuantity = quantityInput.value;
            }
        }

        function decreaseQuantity() {
            const quantityInput = document.getElementById('quantity');
            const currentValue = parseInt(quantityInput.value);
            
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
                currentQuantity = quantityInput.value;
            }
        }

        // Add to cart
        function addToCart() {
            if (!currentProduct) return;
            
            const quantity = parseInt(document.getElementById('quantity').value);
            const maxStock = currentProduct.stock_quantity || currentProduct.stock || 0;
            
            if (quantity > maxStock) {
                alert('Số lượng vượt quá tồn kho!');
                return;
            }
            
            // Use app.js addToCart function if available
            if (window.app && window.app.addToCart) {
                window.app.addToCart(currentProduct.id, quantity);
            } else {
                // Fallback
                let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const existingItem = cart.find(item => item.id === currentProduct.id);
                
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cart.push({
                        id: currentProduct.id,
                        name: currentProduct.name,
                        price: currentProduct.price,
                        image: currentProduct.images ? currentProduct.images[0] : '',
                        quantity: quantity
                    });
                }
                
                localStorage.setItem('cart', JSON.stringify(cart));
                loadCartCount();
                alert('Đã thêm vào giỏ hàng!');
            }
        }

        // Buy now
        function buyNow() {
            addToCart();
            window.location.href = 'cart.html';
        }

        // Toggle wishlist
        function toggleWishlist() {
            if (!currentProduct) return;
            
            // Use app.js toggleWishlist function if available
            if (window.app && window.app.toggleWishlist) {
                window.app.toggleWishlist(currentProduct.id);
            } else {
                // Fallback
                let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
                const existingIndex = wishlist.findIndex(item => item.id === currentProduct.id);
                
                if (existingIndex > -1) {
                    wishlist.splice(existingIndex, 1);
                    document.getElementById('wishlistBtn').innerHTML = '<i class="far fa-heart me-2"></i>Thêm vào yêu thích';
                } else {
                    wishlist.push({
                        id: currentProduct.id,
                        name: currentProduct.name,
                        price: currentProduct.price,
                        image: currentProduct.images ? currentProduct.images[0] : ''
                    });
                    document.getElementById('wishlistBtn').innerHTML = '<i class="fas fa-heart me-2"></i>Đã yêu thích';
                }
                
                localStorage.setItem('wishlist', JSON.stringify(wishlist));
            }
        }

        // Share product
        function shareProduct() {
            if (navigator.share) {
                navigator.share({
                    title: currentProduct.name,
                    text: currentProduct.description,
                    url: window.location.href
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Đã copy link sản phẩm!');
                });
            }
        }

        // Load related products
        async function loadRelatedProducts(categoryId, brandId) {
            try {
                const response = await fetch(`/api/products?category=${categoryId}&limit=12`);
                const data = await response.json();
                
                if (response.ok && Array.isArray(data)) {
                    const shuffled = data
                        .filter(p => p.id !== currentProduct.id)
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 4);
                    displayRelatedProducts(shuffled);
                } else if (data.products) {
                    const shuffled = data.products
                        .filter(p => p.id !== currentProduct.id)
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 4);
                    displayRelatedProducts(shuffled);
                }
            } catch (error) {
                console.error('Error loading related products:', error);
            }
        }

        // Display related products
        function displayRelatedProducts(products) {
            const container = document.getElementById('relatedProducts');
            container.innerHTML = '';
            
            products.forEach(product => {
                if (product.id === currentProduct.id) return; // Skip current product
                
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-4';
                col.innerHTML = `
                    <div class="card h-100">
                        <img src="${product.imageUrl || product.primary_image || '/static/products/placeholder.jpg'}" 
                             class="card-img-top" style="height: 200px; object-fit: cover;">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">${product.name}</h6>
                            <p class="text-primary fw-bold">${Number((product.is_on_sale && product.sale_price) ? product.sale_price : product.price).toLocaleString('vi-VN')} ₫</p>
                            <a href="product-detail.html?id=${product.id}" class="btn btn-primary mt-auto">Xem chi tiết</a>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        // Load cart count
        function loadCartCount() {
            const cart = JSON.parse(localStorage.getItem('tmdt_cart') || '[]');
            const count = cart.reduce((total, item) => total + item.quantity, 0);
            document.getElementById('cartCount').textContent = count;
        }

        // Update user menu
        function updateUserMenu() {
            const user = JSON.parse(localStorage.getItem('tmdt_user') || '{}');
            const userMenu = document.getElementById('userMenu');
            
            if (user && (user.id || user.email)) {
                const displayName = user.firstName || user.first_name || user.lastName || 'User';
                userMenu.innerHTML = `
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> ${displayName}
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="profile.html">Hồ sơ</a></li>
                        <li><a class="dropdown-item" href="orders.html">Đơn hàng</a></li>
                        <li><a class="dropdown-item" href="wishlist.html">Yêu thích</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()">Đăng xuất</a></li>
                    </ul>
                `;
            } else {
                userMenu.innerHTML = `
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> Tài khoản
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="login.html">Đăng nhập</a></li>
                        <li><a class="dropdown-item" href="register.html">Đăng ký</a></li>
                    </ul>
                `;
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('tmdt_user');
            localStorage.removeItem('tmdt_token');
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>


