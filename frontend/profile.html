<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ sơ cá nhân - EasyBuy</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Custom Theme -->
    <link href="assets/css/customer-theme.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-shopping-bag"></i>EasyBuy
            </a>
            
            <div class="navbar-nav ms-auto">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-home me-1"></i>Trang chủ
                </a>
                <a href="products.html" class="nav-link">
                    <i class="fas fa-box me-1"></i>Sản phẩm
                </a>
                <a href="cart.html" class="nav-link">
                    <i class="fas fa-shopping-cart me-1"></i>Giỏ hàng
                </a>
                <a href="orders.html" class="nav-link">
                    <i class="fas fa-shopping-bag me-1"></i>Đơn hàng
                </a>
                <a href="profile.html" class="nav-link active">
                    <i class="fas fa-user me-1"></i>Hồ sơ
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-3">
                <!-- Sidebar -->
                <div class="card">
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <i class="fas fa-user-circle fa-5x text-primary"></i>
                        </div>
                        <h5 id="userName">Tên người dùng</h5>
                        <p class="text-muted" id="userEmail">email@example.com</p>
                    </div>
                </div>
                
                <!-- Navigation Menu -->
                <div class="list-group mt-3">
                    <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="tab">
                        <i class="fas fa-user me-2"></i>Thông tin cá nhân
                    </a>
                    <a href="#addresses" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="fas fa-map-marker-alt me-2"></i>Địa chỉ
                    </a>
                    <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="fas fa-lock me-2"></i>Bảo mật
                    </a>
                    <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="fas fa-bell me-2"></i>Thông báo
                    </a>
                    <a href="#" class="list-group-item list-group-item-action text-danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                    </a>
                </div>
            </div>
            
            <div class="col-md-9">
                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Profile Tab -->
                    <div class="tab-pane fade show active" id="profile">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-user me-2"></i>Thông tin cá nhân</h5>
                            </div>
                            <div class="card-body">
                                <form id="profileForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="firstName" class="form-label">Họ</label>
                                            <input type="text" class="form-control" id="firstName" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="lastName" class="form-label">Tên</label>
                                            <input type="text" class="form-control" id="lastName" required>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="email" readonly>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="phone" class="form-label">Số điện thoại</label>
                                        <input type="tel" class="form-control" id="phone">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="birthday" class="form-label">Ngày sinh</label>
                                        <input type="date" class="form-control" id="birthday">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="gender" class="form-label">Giới tính</label>
                                        <select class="form-select" id="gender">
                                            <option value="male">Nam</option>
                                            <option value="female">Nữ</option>
                                            <option value="other">Khác</option>
                                        </select>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Cập nhật thông tin
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Addresses Tab -->
                    <div class="tab-pane fade" id="addresses">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Địa chỉ</h5>
                                <button class="btn btn-primary btn-sm" onclick="profilePage.addAddress()">
                                    <i class="fas fa-plus me-1"></i>Thêm địa chỉ
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="addressList">
                                    <!-- Addresses will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Tab -->
                    <div class="tab-pane fade" id="security">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-lock me-2"></i>Bảo mật</h5>
                            </div>
                            <div class="card-body">
                                <form id="passwordForm">
                                    <div class="mb-3">
                                        <label for="currentPassword" class="form-label">Mật khẩu hiện tại</label>
                                        <input type="password" class="form-control" id="currentPassword" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="newPassword" class="form-label">Mật khẩu mới</label>
                                        <input type="password" class="form-control" id="newPassword" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
                                        <input type="password" class="form-control" id="confirmPassword" required>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-key me-2"></i>Đổi mật khẩu
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notifications Tab -->
                    <div class="tab-pane fade" id="notifications">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Cài đặt thông báo</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                    <label class="form-check-label" for="emailNotifications">
                                        Nhận thông báo qua email
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="smsNotifications">
                                    <label class="form-check-label" for="smsNotifications">
                                        Nhận thông báo qua SMS
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="orderUpdates" checked>
                                    <label class="form-check-label" for="orderUpdates">
                                        Cập nhật đơn hàng
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="promotions" checked>
                                    <label class="form-check-label" for="promotions">
                                        Khuyến mãi và ưu đãi
                                    </label>
                                </div>
                                
                                <button class="btn btn-primary" onclick="profilePage.saveNotifications()">
                                    <i class="fas fa-save me-2"></i>Lưu cài đặt
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Auth Manager -->
    <script src="assets/js/auth.js"></script>
    
    <script>
        class ProfilePage {
            constructor() {
                this.user = null;
                this.addresses = [];
                this.apiBaseUrl = 'http://localhost:3000/api';
                this.init();
            }
            
            init() {
                this.loadUser();
                this.loadAddresses();
                this.setupEventListeners();
            }
            
            loadUser() {
                // Check for accessToken in localStorage (from login)
                const accessToken = localStorage.getItem('accessToken');
                if (accessToken) {
                    try {
                        const payload = JSON.parse(atob(accessToken.split('.')[1]));
                        this.user = {
                            id: payload.id,
                            email: payload.email,
                            firstName: payload.firstName,
                            lastName: payload.lastName,
                            accessToken: accessToken
                        };
                        this.loadUserProfile();
                        return;
                    } catch (error) {
                        console.error('Error parsing token:', error);
                        localStorage.removeItem('accessToken');
                    }
                }

                // Fallback to legacy structure
                const tmdtUserStr = localStorage.getItem('tmdt_user');
                if (tmdtUserStr) {
                    this.user = JSON.parse(tmdtUserStr);
                } else {
                    const legacyUserStr = localStorage.getItem('currentUser');
                    const legacyToken = localStorage.getItem('token');
                    if (legacyUserStr && legacyToken) {
                        const legacyUser = JSON.parse(legacyUserStr);
                        this.user = { ...legacyUser, accessToken: legacyToken };
                    }
                }

                // If no token, show default data
                if (!this.user || !this.user.accessToken) {
                    this.user = this.user || {};
                    this.userProfile = null;
                    this.updateUserInfo();
                    this.populateForm();
                } else {
                    this.loadUserProfile();
                }
            }
            
            async loadUserProfile() {
                try {
                    const response = await this.apiCall('/user/profile');
                    this.userProfile = response;
                    this.updateUserInfo();
                    this.populateForm();
                } catch (error) {
                    console.error('Error loading user profile:', error);
                    this.showNotification('Không thể tải thông tin hồ sơ', 'error');
                }
            }
            
            updateUserInfo() {
                const profile = this.userProfile || {};
                const fallbackFirst = (profile.first_name || this.user?.firstName || 'Người').toString();
                const fallbackLast = (profile.last_name || this.user?.lastName || 'Dùng').toString();
                const fallbackEmail = (profile.email || this.user?.email || 'email@example.com').toString();

                document.getElementById('userName').textContent = `${fallbackFirst} ${fallbackLast}`.trim();
                document.getElementById('userEmail').textContent = fallbackEmail;
            }
            
            populateForm() {
                const p = this.userProfile || {};
                document.getElementById('firstName').value = p.first_name || this.user?.firstName || 'Người';
                document.getElementById('lastName').value = p.last_name || this.user?.lastName || 'Dùng';
                document.getElementById('email').value = p.email || this.user?.email || 'email@example.com';
                document.getElementById('phone').value = p.phone || '';
                document.getElementById('birthday').value = p.date_of_birth || '';
                document.getElementById('gender').value = p.gender || 'male';
            }
            
            async loadAddresses() {
                try {
                    const response = await this.apiCall('/user/addresses');
                    this.addresses = response.addresses || [];
                    this.renderAddresses();
                } catch (error) {
                    console.error('Error loading addresses:', error);
                    this.addresses = [];
                this.renderAddresses();
                }
            }
            
            renderAddresses() {
                const container = document.getElementById('addressList');
                if (this.addresses.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Chưa có địa chỉ nào</h6>
                            <button class="btn btn-primary" onclick="profilePage.addAddress()">
                                <i class="fas fa-plus me-1"></i>Thêm địa chỉ đầu tiên
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.addresses.map(addr => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        ${addr.recipient_name}
                                        ${addr.is_default ? '<span class="badge bg-primary ms-2">Mặc định</span>' : ''}
                                    </h6>
                                    <p class="mb-1">${addr.address_line1}${addr.address_line2 ? ', ' + addr.address_line2 : ''}</p>
                                    <p class="mb-1">${addr.city}, ${addr.state} ${addr.postal_code}</p>
                                    <small class="text-muted">${addr.phone}</small>
                                </div>
                                <div>
                                    <button class="btn btn-outline-primary btn-sm me-2" onclick="profilePage.editAddress(${addr.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="profilePage.deleteAddress(${addr.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            setupEventListeners() {
                // Profile form
                document.getElementById('profileForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateProfile();
                });
                
                // Password form
                document.getElementById('passwordForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.changePassword();
                });
            }
            
            async updateProfile() {
                try {
                    const formData = {
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        phone: document.getElementById('phone').value,
                        dateOfBirth: document.getElementById('birthday').value,
                        gender: document.getElementById('gender').value
                    };
                    
                    await this.apiCall('/user/profile', {
                        method: 'PUT',
                        body: JSON.stringify(formData)
                    });
                    
                    this.showNotification('Cập nhật thông tin thành công!', 'success');
                    this.loadUserProfile(); // Reload profile data
                } catch (error) {
                    console.error('Error updating profile:', error);
                    this.showNotification('Có lỗi xảy ra khi cập nhật thông tin', 'error');
                }
            }
            
            changePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    alert('Mật khẩu xác nhận không khớp!');
                    return;
                }
                
                alert('Đổi mật khẩu thành công!');
                document.getElementById('passwordForm').reset();
            }
            
            addAddress() {
                this.showAddressModal();
            }
            
            editAddress(id) {
                const address = this.addresses.find(addr => addr.id === id);
                if (address) {
                    this.showAddressModal(address);
                }
            }
            
            async deleteAddress(id) {
                if (confirm('Bạn có chắc muốn xóa địa chỉ này?')) {
                    try {
                        await this.apiCall(`/user/addresses/${id}`, {
                            method: 'DELETE'
                        });
                        this.showNotification('Xóa địa chỉ thành công!', 'success');
                        this.loadAddresses();
                    } catch (error) {
                        console.error('Error deleting address:', error);
                        this.showNotification('Có lỗi xảy ra khi xóa địa chỉ', 'error');
                    }
                }
            }
            
            showAddressModal(address = null) {
                // Create modal HTML
                const modalHtml = `
                    <div class="modal fade" id="addressModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">${address ? 'Chỉnh sửa địa chỉ' : 'Thêm địa chỉ mới'}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="addressForm">
                                        <div class="mb-3">
                                            <label for="addressType" class="form-label">Loại địa chỉ</label>
                                            <select class="form-select" id="addressType">
                                                <option value="home" ${address?.type === 'home' ? 'selected' : ''}>Nhà riêng</option>
                                                <option value="work" ${address?.type === 'work' ? 'selected' : ''}>Công ty</option>
                                                <option value="other" ${address?.type === 'other' ? 'selected' : ''}>Khác</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="recipientName" class="form-label">Tên người nhận</label>
                                            <input type="text" class="form-control" id="recipientName" value="${address?.recipient_name || ''}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="recipientPhone" class="form-label">Số điện thoại</label>
                                            <input type="tel" class="form-control" id="recipientPhone" value="${address?.phone || ''}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="addressLine1" class="form-label">Địa chỉ</label>
                                            <input type="text" class="form-control" id="addressLine1" value="${address?.address_line1 || ''}" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="addressLine2" class="form-label">Địa chỉ bổ sung (tùy chọn)</label>
                                            <input type="text" class="form-control" id="addressLine2" value="${address?.address_line2 || ''}">
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="city" class="form-label">Thành phố</label>
                                                <input type="text" class="form-control" id="city" value="${address?.city || ''}" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="state" class="form-label">Tỉnh/Thành phố</label>
                                                <input type="text" class="form-control" id="state" value="${address?.state || ''}" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="postalCode" class="form-label">Mã bưu điện</label>
                                                <input type="text" class="form-control" id="postalCode" value="${address?.postal_code || ''}" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="country" class="form-label">Quốc gia</label>
                                                <input type="text" class="form-control" id="country" value="${address?.country || 'Vietnam'}" required>
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isDefault" ${address?.is_default ? 'checked' : ''}>
                                            <label class="form-check-label" for="isDefault">
                                                Đặt làm địa chỉ mặc định
                                            </label>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="button" class="btn btn-primary" onclick="profilePage.saveAddress(${address?.id || 'null'})">Lưu</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('addressModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('addressModal'));
                modal.show();
            }
            
            async saveAddress(addressId) {
                try {
                    const formData = {
                        type: document.getElementById('addressType').value,
                        recipientName: document.getElementById('recipientName').value,
                        phone: document.getElementById('recipientPhone').value,
                        addressLine1: document.getElementById('addressLine1').value,
                        addressLine2: document.getElementById('addressLine2').value,
                        city: document.getElementById('city').value,
                        state: document.getElementById('state').value,
                        postalCode: document.getElementById('postalCode').value,
                        country: document.getElementById('country').value,
                        isDefault: document.getElementById('isDefault').checked
                    };
                    
                    if (addressId) {
                        // Update existing address
                        await this.apiCall(`/user/addresses/${addressId}`, {
                            method: 'PUT',
                            body: JSON.stringify(formData)
                        });
                        this.showNotification('Cập nhật địa chỉ thành công!', 'success');
                    } else {
                        // Create new address
                        await this.apiCall('/user/addresses', {
                            method: 'POST',
                            body: JSON.stringify(formData)
                        });
                        this.showNotification('Thêm địa chỉ thành công!', 'success');
                    }
                    
                    // Close modal and reload addresses
                    bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide();
                    this.loadAddresses();
                } catch (error) {
                    console.error('Error saving address:', error);
                    this.showNotification('Có lỗi xảy ra khi lưu địa chỉ', 'error');
                }
            }
            
            saveNotifications() {
                alert('Đã lưu cài đặt thông báo!');
            }
            
            // API Helper Methods
            async apiCall(endpoint, options = {}) {
                const url = `${this.apiBaseUrl}${endpoint}`;
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (this.user && this.user.accessToken) {
                    defaultOptions.headers.Authorization = `Bearer ${this.user.accessToken}`;
                }

                const config = { ...defaultOptions, ...options };

                try {
                    const response = await fetch(url, config);
                    if (response.status === 401) {
                        // Không chuyển trang để tránh bị bật ra; chỉ thông báo
                        this.showNotification('Phiên đăng nhập đã hết hạn. Dữ liệu mặc định sẽ được hiển thị.', 'error');
                        // Xóa token lỗi để các lần gọi sau không tiếp tục 401
                        try {
                            localStorage.removeItem('tmdt_user');
                            localStorage.removeItem('token');
                        } catch (_) {}
                        throw new Error('Unauthorized');
                    }
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'API call failed');
                    }

                    return data;
                } catch (error) {
                    console.error('API call error:', error);
                    this.showNotification('Có lỗi xảy ra. Vui lòng thử lại sau.', 'error');
                    throw error;
                }
            }
            
            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Add to body
                document.body.appendChild(notification);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }
        }
        
        // Logout function
        function logout() {
            console.log('🚪 Logging out...');
            
            // Clear all stored data
            localStorage.removeItem('accessToken');
            localStorage.removeItem('userInfo');
            localStorage.removeItem('cart');
            
            // Show success message
            alert('Đăng xuất thành công!');
            
            // Redirect to home page
            window.location.href = 'index.html';
        }
        
        // Initialize when page loads
        let profilePage;
        document.addEventListener('DOMContentLoaded', () => {
            profilePage = new ProfilePage();
        });
    </script>
</body>
</html>

